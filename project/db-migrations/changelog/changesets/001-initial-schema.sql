--liquibase formatted sql
--changeset yourname:001-initial-schema

-- Crear tabla USERS (tabla base)
CREATE TABLE USERS (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(255) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    ROLE VARCHAR2(20) NOT NULL CHECK (role IN ('Manager', 'Developer', 'Tester')),
    WORK_MODE VARCHAR2(20) NOT NULL CHECK (work_mode IN ('On Site', 'Hybrid', 'Remote')),
    TELEGRAM_CHAT_ID NUMBER UNIQUE,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    IS_ACTIVE NUMBER(1,0) DEFAULT 1 NOT NULL
);

-- Crear tabla TEAMS
CREATE TABLE TEAMS (
    TEAM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TEAM_NAME VARCHAR2(255) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Crear tabla EPICS
CREATE TABLE EPICS (
    EPIC_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    STATUS VARCHAR2(20) NOT NULL CHECK (status IN ('ToDo', 'InProgress', 'Done')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Crear tabla SPRINTS
CREATE TABLE SPRINTS (
    SPRINT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(255) NOT NULL,
    START_DATE DATE NOT NULL,
    END_DATE DATE NOT NULL,
    STATUS VARCHAR2(20) NOT NULL CHECK (status IN ('Planned', 'Active', 'Completed'))
);

-- Crear tabla TASKS
CREATE TABLE TASKS (
    TASK_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    EPIC_ID NUMBER,
    PRIORITY VARCHAR2(20) NOT NULL CHECK (priority IN ('Low', 'Medium', 'High')),
    STATUS VARCHAR2(20) NOT NULL CHECK (status IN ('Backlog', 'ToDo', 'InProgress', 'Done', 'Blocked')),
    TYPE VARCHAR2(20) NOT NULL CHECK (type IN ('Ticket', 'Bug', 'Feature', 'Improvement')),
    ESTIMATED_DEADLINE DATE,
    REAL_DEADLINE DATE,
    USER_POINTS NUMBER(3,0) CHECK (user_points > 0),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ESTIMATED_HOURS NUMBER,
    REAL_HOURS NUMBER,
    CONSTRAINT FK_TASKS_EPIC FOREIGN KEY (EPIC_ID) REFERENCES EPICS(EPIC_ID) ON DELETE CASCADE
);

-- Crear tablas de relaci√≥n
CREATE TABLE USER_TEAMS (
    USER_ID NUMBER NOT NULL,
    TEAM_ID NUMBER NOT NULL,
    PRIMARY KEY (USER_ID, TEAM_ID),
    CONSTRAINT FK_USER_TEAMS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_USER_TEAMS_TEAM FOREIGN KEY (TEAM_ID) REFERENCES TEAMS(TEAM_ID) ON DELETE CASCADE
);

CREATE TABLE TASK_ASSIGNMENTS (
    TASK_ID NUMBER NOT NULL,
    USER_ID NUMBER NOT NULL,
    PRIMARY KEY (TASK_ID, USER_ID),
    CONSTRAINT FK_TASK_ASSIGNMENTS_TASK FOREIGN KEY (TASK_ID) REFERENCES TASKS(TASK_ID) ON DELETE CASCADE,
    CONSTRAINT FK_TASK_ASSIGNMENTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE CASCADE
);

CREATE TABLE TASK_SPRINT (
    TASK_ID NUMBER NOT NULL,
    SPRINT_ID NUMBER NOT NULL,
    PRIMARY KEY (TASK_ID, SPRINT_ID),
    CONSTRAINT FK_TASK_SPRINT_TASK FOREIGN KEY (TASK_ID) REFERENCES TASKS(TASK_ID) ON DELETE CASCADE,
    CONSTRAINT FK_TASK_SPRINT_SPRINT FOREIGN KEY (SPRINT_ID) REFERENCES SPRINTS(SPRINT_ID) ON DELETE CASCADE
);
